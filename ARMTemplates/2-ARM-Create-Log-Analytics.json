{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "workspaceName": {
        "type": "string",
        "metadata": {
          "description": "Workspace name"
        }
      },
      "sku": {
        "type": "string",
        "allowedValues": [
          "PerGB2018",
          "Free",
          "Standalone",
          "PerNode",
          "Standard",
          "Premium"
        ],
        "defaultValue": "pergb2018",
        "metadata": {
          "description": "Pricing tier: pergb2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
        }
      },
      "dataRetention": {
        "type": "int",
        "defaultValue": 30,
        "minValue": 7,
        "maxValue": 730,
        "metadata": {
          "description": "Number of days of retention. Workspaces in the legacy Free pricing tier can only have 7 days."
        }
      },
      "immediatePurgeDataOn30Days": {
        "type": "bool",
        "defaultValue": "[bool('false')]",
        "metadata": {
          "description": "If set to true, changing retention to 30 days will immediately delete older data. Use this with extreme caution. This only applies when retention is being set to 30 days."
        }
      },
      "location": {
        "type": "string",
        "allowedValues": [
          "australiacentral",
          "australiaeast",
          "australiasoutheast",
          "brazilsouth",
          "canadacentral",
          "centralindia",
          "centralus",
          "eastasia",
          "eastus",
          "eastus2",
          "francecentral",
          "japaneast",
          "koreacentral",
          "northcentralus",
          "northeurope",
          "southafricanorth",
          "southcentralus",
          "southeastasia",
          "uksouth",
          "ukwest",
          "westcentralus",
          "westeurope",
          "westus",
          "westus2"
        ],
        "metadata": {
          "description": "Specifies the location in which to create the workspace."
        }
      },
      "applicationDiagnosticsStorageAccountName": {
        "type": "string",
        "metadata": {
          "description": "Name of the storage account with Azure diagnostics output"
        }
      },
      "applicationDiagnosticsStorageAccountResourceGroup": {
        "type": "string",
        "metadata": {
          "description": "The resource group name containing the storage account with Azure diagnostics output"
        }
      },
      "customLogName": {
        "type": "string",
        "metadata": {
          "description": "The custom log name"
        }
      }
    },
    "variables": {
      "Updates": {
        "Name": "[Concat('Updates', '(', parameters('workspaceName'), ')')]",
        "GalleryName": "Updates"
      },
      "AntiMalware": {
        "Name": "[concat('AntiMalware', '(', parameters('workspaceName'), ')')]",
        "GalleryName": "AntiMalware"
      },
      "SQLAssessment": {
        "Name": "[Concat('SQLAssessment', '(', parameters('workspaceName'), ')')]",
        "GalleryName": "SQLAssessment"
      },
      "diagnosticsStorageAccount": "[resourceId(parameters('applicationDiagnosticsStorageAccountResourceGroup'), 'Microsoft.Storage/storageAccounts', parameters('applicationDiagnosticsStorageAccountName'))]"
    },
    "resources": [
      {
        "apiVersion": "2017-03-15-preview",
        "type": "Microsoft.OperationalInsights/workspaces",
        "name": "[parameters('workspaceName')]",
        "location": "[parameters('location')]",
        "properties": {
          "retentionInDays": "[parameters('dataRetention')]",
          "features": {
            "immediatePurgeDataOn30Days": "[parameters('immediatePurgeDataOn30Days')]"
          },
          "sku": {
            "name": "[parameters('sku')]"
          }
        },
        "resources": [
          {
            "apiVersion": "2015-03-20",
            "name": "VMSS Queries2",
            "type": "savedSearches",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "eTag": "*",
              "category": "VMSS",
              "displayName": "VMSS Instance Count",
              "query": "Event | where Source == \"ServiceFabricNodeBootstrapAgent\" | summarize AggregatedValue = count() by Computer",
              "version": 1
            }
          },
          {
            "apiVersion": "2017-04-26-preview",
            "name": "Cross workspace function",
            "type": "savedSearches",
              "dependsOn": [
               "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
              ],
              "properties": {
                "etag": "*",
                "displayName": "failedLogOnEvents",
                "category": "Security",
                "FunctionAlias": "failedlogonsecurityevents",
                "query": "
                  union withsource=SourceWorkspace
                  workspace('workspace1').SecurityEvent,
                  workspace('workspace2').SecurityEvent,
                  workspace('workspace3').SecurityEvent,
                  | where EventID == 4625"
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleWindowsEvent1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsEvent",
            "properties": {
              "eventLogName": "Application",
              "eventTypes": [
                {
                  "eventType": "Error"
                },
                {
                  "eventType": "Warning"
                }
              ]
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleWindowsPerfCounter1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "WindowsPerformanceCounter",
            "properties": {
              "objectName": "Memory",
              "instanceName": "*",
              "intervalSeconds": 10,
              "counterName": "Available MBytes"
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleIISLog1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "IISLogs",
            "properties": {
              "state": "OnPremiseEnabled"
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleSyslog1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslog",
            "properties": {
              "syslogName": "kern",
              "syslogSeverities": [
                {
                  "severity": "emerg"
                },
                {
                  "severity": "alert"
                },
                {
                  "severity": "crit"
                },
                {
                  "severity": "err"
                },
                {
                  "severity": "warning"
                }
              ]
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleSyslogCollection1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxSyslogCollection",
            "properties": {
              "state": "Enabled"
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleLinuxPerf1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxPerformanceObject",
            "properties": {
              "performanceCounters": [
                {
                  "counterName": "% Used Inodes"
                },
                {
                  "counterName": "Free Megabytes"
                },
                {
                  "counterName": "% Used Space"
                },
                {
                  "counterName": "Disk Transfers/sec"
                },
                {
                  "counterName": "Disk Reads/sec"
                },
                {
                  "counterName": "Disk Writes/sec"
                }
              ],
              "objectName": "Logical Disk",
              "instanceName": "*",
              "intervalSeconds": 10
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "dataSources",
            "name": "[concat(parameters('workspaceName'), parameters('customLogName'))]",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', '/', parameters('workspaceName'))]"
            ],
            "kind": "CustomLog",
            "properties": {
              "customLogName": "[parameters('customLogName')]",
              "description": "this is a description",
              "extractions": [
                {
                  "extractionName": "TimeGenerated",
                  "extractionProperties": {
                    "dateTimeExtraction": {
                      "regex": [
                        {
                          "matchIndex": 0,
                          "numberdGroup": null,
                          "pattern": "((\\d{2})|(\\d{4}))-([0-1]\\d)-(([0-3]\\d)|(\\d))\\s((\\d)|([0-1]\\d)|(2[0-4])):[0-5][0-9]:[0-5][0-9]"
                        }
                      ]
                    }
                  },
                  "extractionType": "DateTime"
                }
              ],
              "inputs": [
                {
                  "location": {
                    "fileSystemLocations": {
                      "linuxFileTypeLogPaths": null,
                      "windowsFileTypeLogPaths": [
                        "[concat('c:\\Windows\\Logs\\',parameters('customLogName'))]"
                      ]
                    }
                  },
                  "recordDelimiter": {
                    "regexDelimiter": {
                      "matchIndex": 0,
                      "numberdGroup": null,
                      "pattern": "(^.*((\\d{2})|(\\d{4}))-([0-1]\\d)-(([0-3]\\d)|(\\d))\\s((\\d)|([0-1]\\d)|(2[0-4])):[0-5][0-9]:[0-5][0-9].*$)"
                    }
                  }
                }
              ]
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "type": "datasources",
            "name": "sampleLinuxPerfCollection1",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "kind": "LinuxPerformanceCollection",
            "properties": {
              "state": "Enabled"
            }
          },
          {
            "apiVersion": "2015-03-20",
            "name": "[concat(parameters('applicationDiagnosticsStorageAccountName'),parameters('workspaceName'))]",
            "type": "storageinsightconfigs",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "containers": [
                "wad-iis-logfiles"
              ],
              "tables": [
                "WADWindowsEventLogsTable"
              ],
              "storageAccount": {
                "id": "[variables('diagnosticsStorageAccount')]",
                "key": "[listKeys(variables('diagnosticsStorageAccount'),'2015-06-15').key1]"
              }
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('location')]",
            "name": "[variables('Updates').Name]",
            "type": "Microsoft.OperationsManagement/solutions",
            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationsManagement/solutions/', variables('Updates').Name)]",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            },
            "plan": {
              "name": "[variables('Updates').Name]",
              "publisher": "Microsoft",
              "product": "[Concat('OMSGallery/', variables('Updates').GalleryName)]",
              "promotionCode": ""
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('location')]",
            "name": "[variables('AntiMalware').Name]",
            "type": "Microsoft.OperationsManagement/solutions",
            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationsManagement/solutions/', variables('AntiMalware').Name)]",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            },
            "plan": {
              "name": "[variables('AntiMalware').Name]",
              "publisher": "Microsoft",
              "product": "[Concat('OMSGallery/', variables('AntiMalware').GalleryName)]",
              "promotionCode": ""
            }
          },
          {
            "apiVersion": "2015-11-01-preview",
            "location": "[parameters('location')]",
            "name": "[variables('SQLAssessment').Name]",
            "type": "Microsoft.OperationsManagement/solutions",
            "id": "[concat('/subscriptions/', subscription().subscriptionId, '/resourceGroups/', resourceGroup().name, '/providers/Microsoft.OperationsManagement/solutions/', variables('SQLAssessment').Name)]",
            "dependsOn": [
              "[concat('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            ],
            "properties": {
              "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces/', parameters('workspaceName'))]"
            },
            "plan": {
              "name": "[variables('SQLAssessment').Name]",
              "publisher": "Microsoft",
              "product": "[Concat('OMSGallery/', variables('SQLAssessment').GalleryName)]",
              "promotionCode": ""
            }
          }
        ]
      }
    ],
    "outputs": {
      "workspaceName": {
        "type": "string",
        "value": "[parameters('workspaceName')]"
      },
      "provisioningState": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').provisioningState]"
      },
      "source": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').source]"
      },
      "customerId": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').customerId]"
      },
      "sku": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').sku.name]"
      },
      "retentionInDays": {
        "type": "int",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').retentionInDays]"
      },
      "immediatePurgeDataOn30Days": {
        "type": "bool",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').features.immediatePurgeDataOn30Days]"
      },
      "portalUrl": {
        "type": "string",
        "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('workspaceName')), '2015-11-01-preview').portalUrl]"
      }
    }
}
